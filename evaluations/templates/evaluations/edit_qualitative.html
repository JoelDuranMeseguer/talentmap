{% extends "base.html" %}
{% load eval_extras %}
{% block title %}Cualitativo ¬∑ {{ competency.name }} ¬∑ TalentMap{% endblock %}

{% block content %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-1">Cualitativo ¬∑ {{ competency.name }}</h3>
      <div class="text-muted">{{ employee }} ¬∑ {{ cycle.name }} ¬∑ Requerido hasta nivel {{ required_level }}</div>
    </div>
    {% if is_self_assessment %}
      <a class="btn btn-outline-secondary" href="{% url 'self_competency_picker' %}">Volver</a>
    {% else %}
      <a class="btn btn-outline-secondary" href="{% url 'competency_picker' employee_id=employee.id %}">Volver</a>
    {% endif %}
  </div>
  {% if missing_level %}
  <p><strong>‚ö† Configuraci√≥n incompleta:</strong> el nivel {{ missing_level }} no tiene comportamientos configurados. Contacta con HR/Admin.</p>
  {% endif %}

  <div class="card p-4 mb-3">
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <span class="badge text-bg-success">Nivel completado: <span id="achieved-badge">{{ achieved_level }}</span></span>
      <span class="badge text-bg-primary">Nivel actual: <span id="current-badge">{{ current_level }}</span>/{{ required_level }}</span>
      <span class="text-muted small">
        Para subir: todos los comportamientos del nivel anterior en <strong>Casi siempre</strong> o <strong>Siempre</strong>.
      </span>
    </div>
    <div class="mt-3 d-flex flex-wrap gap-2">
      <span class="badge text-bg-danger">Nunca</span>
      <span class="badge text-bg-warning text-dark">Casi nunca</span>
      <span class="badge text-bg-info text-dark">Casi siempre</span>
      <span class="badge text-bg-success">Siempre</span>
    </div>
  </div>

  <form method="post" id="qual-form" data-pass-rating="{{ PASS_RATING }}" data-required-level="{{ required_level }}">
    {% csrf_token %}

    <div class="accordion" id="levelsAccordion">
      {% for l in levels_ctx %}
        {% with lvl=l.level.level %}
        <div class="accordion-item js-level {% if l.locked_initial %}opacity-75{% endif %}"
             data-level="{{ lvl }}"
             data-initial-locked="{% if l.locked_initial %}1{% else %}0{% endif %}">
          <h2 class="accordion-header" id="heading-{{ lvl }}">
            <button class="accordion-button {% if l.locked_initial %}collapsed{% endif %}"
                    type="button"
                    {% if not l.locked_initial %}
                      data-bs-toggle="collapse" data-bs-target="#collapse-{{ lvl }}"
                      aria-expanded="true" aria-controls="collapse-{{ lvl }}"
                    {% else %}
                      disabled
                    {% endif %}>
              <div class="w-100 d-flex justify-content-between align-items-center">
                <div>
                  <span class="fw-semibold">Nivel {{ lvl }}</span>
                  {% if l.level.title %}<span class="text-muted"> ¬∑ {{ l.level.title }}</span>{% endif %}
                  <div class="text-muted small">
                    <span class="js-progress" data-level="{{ lvl }}">{{ l.passed }}/{{ l.total }}</span>
                    en ‚ÄúCasi siempre / Siempre‚Äù
                  </div>
                </div>

                <span class="badge js-status-badge
                             {% if lvl <= achieved_level %}text-bg-success
                             {% elif lvl == current_level %}text-bg-primary
                             {% elif l.locked_initial %}text-bg-light text-dark border
                             {% else %}text-bg-light text-dark border{% endif %}"
                      data-level="{{ lvl }}">
                    {% if l.missing_config %} Sin configurar
                    {% elif lvl <= achieved_level %} Completado
                    {% elif lvl == current_level %} En progreso
                    {% else %}
                    {% if l.locked_initial %}Bloqueado üîí{% else %}Pendiente{% endif %}
                  {% endif %}
                </span>
              </div>
            </button>
          </h2>

          <div id="collapse-{{ lvl }}"
               class="accordion-collapse collapse {% if not l.locked_initial %}show{% endif %}"
               aria-labelledby="heading-{{ lvl }}" data-bs-parent="#levelsAccordion">
            <div class="accordion-body">
              {% if l.locked_initial %}
                <div class="alert alert-light border mb-0">
                  {% if l.missing_config %}
                    Este nivel no tiene comportamientos configurados. Contacta con HR/Admin.
                  {% else %}
                    Completa el nivel anterior para desbloquear este nivel.
                  {% endif %}
                </div>
              {% else %}
                <div class="vstack gap-2">
                  {% for ind in l.indicators %}
                    {% with current=rating_map|get:ind.id|default:1 %}
                    <div class="d-flex flex-column flex-md-row justify-content-between gap-2 py-2 border-bottom">
                      <div class="me-3">
                        <div>{{ ind.text }}</div>
                        {% if not is_self_assessment and self_rating_map|get:ind.id %}
                          <div class="text-muted small mt-1">
                            Autoevaluaci√≥n: <strong>{{ self_rating_map|get:ind.id }}/4</strong>
                          </div>
                        {% endif %}
                      </div>

                      <div class="btn-group btn-group-sm" role="group" aria-label="rating">
                        <input class="btn-check js-rating" type="radio" name="ind_{{ ind.id }}"
                               id="ind_{{ ind.id }}_1" value="1" data-ind="{{ ind.id }}" data-level="{{ lvl }}"
                               {% if current == 1 %}checked{% endif %}>
                        <label class="btn btn-outline-danger" for="ind_{{ ind.id }}_1">Nunca</label>

                        <input class="btn-check js-rating" type="radio" name="ind_{{ ind.id }}"
                               id="ind_{{ ind.id }}_2" value="2" data-ind="{{ ind.id }}" data-level="{{ lvl }}"
                               {% if current == 2 %}checked{% endif %}>
                        <label class="btn btn-outline-warning" for="ind_{{ ind.id }}_2">Casi nunca</label>

                        <input class="btn-check js-rating" type="radio" name="ind_{{ ind.id }}"
                               id="ind_{{ ind.id }}_3" value="3" data-ind="{{ ind.id }}" data-level="{{ lvl }}"
                               {% if current == 3 %}checked{% endif %}>
                        <label class="btn btn-outline-info" for="ind_{{ ind.id }}_3">Casi siempre</label>

                        <input class="btn-check js-rating" type="radio" name="ind_{{ ind.id }}"
                               id="ind_{{ ind.id }}_4" value="4" data-ind="{{ ind.id }}" data-level="{{ lvl }}"
                               {% if current == 4 %}checked{% endif %}>
                        <label class="btn btn-outline-success" for="ind_{{ ind.id }}_4">Siempre</label>
                      </div>
                    </div>
                    {% endwith %}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    </div>

    <div class="d-flex gap-2 mt-3">
      <button class="btn btn-primary" type="submit">Guardar</button>
      {% if is_self_assessment %}
        <a class="btn btn-outline-secondary" href="{% url 'self_competency_picker' %}">Cancelar</a>
      {% else %}
        <a class="btn btn-outline-secondary" href="{% url 'competency_picker' employee_id=employee.id %}">Cancelar</a>
      {% endif %}
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const form = document.getElementById("qual-form");
  const passRating = parseInt(form.dataset.passRating, 10);
  const requiredLevel = parseInt(form.dataset.requiredLevel, 10);

  function getSelectedValue(levelEl, indId) {
    const checked = levelEl.querySelector(`input[name="ind_${indId}"]:checked`);
    return checked ? parseInt(checked.value, 10) : 1;
  }

  function updateStatusBadge(lvlEl, lvl, achieved, unlockedMax, locked) {
    const badge = lvlEl.querySelector(`.js-status-badge[data-level="${lvl}"]`);
    if (!badge) return;

    badge.className = "badge js-status-badge"; // reset limpio

    if (lvl <= achieved) {
      badge.classList.add("text-bg-success");
      badge.textContent = "Completado";
    } else if (lvl === unlockedMax) {
      badge.classList.add("text-bg-primary");
      badge.textContent = "En progreso";
    } else if (locked) {
      badge.classList.add("text-bg-light", "text-dark", "border");
      badge.textContent = "Bloqueado üîí";
    } else {
      badge.classList.add("text-bg-light", "text-dark", "border");
      badge.textContent = "Pendiente";
    }
  }

  function recompute() {
    const levelEls = Array.from(document.querySelectorAll(".js-level"))
      .sort((a, b) => parseInt(a.dataset.level, 10) - parseInt(b.dataset.level, 10));

    let achieved = 0;
    let unlockedMax = 1;

    // 1) Calcula achieved / unlockedMax seg√∫n ratings actuales
    for (const lvlEl of levelEls) {
      const lvl = parseInt(lvlEl.dataset.level, 10);
      if (lvl > requiredLevel) continue;

      const radios = Array.from(lvlEl.querySelectorAll("input.js-rating[type=radio]"));
      const indIds = Array.from(new Set(radios.map(r => r.dataset.ind)));

      const total = indIds.length;
      let passed = 0;

      for (const indId of indIds) {
        const v = getSelectedValue(lvlEl, indId);
        if (v >= passRating) passed++;
      }

      const prog = lvlEl.querySelector(`.js-progress[data-level="${lvl}"]`);
      if (prog) prog.textContent = `${passed}/${total}`;

      const completed = (total === 0) || (passed === total);
      if (completed) {
        achieved = lvl;
        unlockedMax = Math.min(lvl + 1, requiredLevel);
      } else {
        unlockedMax = lvl;
        break;
      }
    }

    if (achieved >= requiredLevel) unlockedMax = requiredLevel;

    // 2) Aplica bloqueo/desbloqueo + actualiza badges por nivel
    for (const lvlEl of levelEls) {
      const lvl = parseInt(lvlEl.dataset.level, 10);
      const locked = lvl > unlockedMax;

      // estado para E2E
      lvlEl.dataset.locked = locked ? "1" : "0";

      // inputs bloqueados deshabilitados (no se env√≠an)
      lvlEl.querySelectorAll("input.js-rating").forEach(inp => {
        inp.disabled = locked;
      });

      // accordion: bloqueado = colapsado y deshabilitado
      const headerBtn = lvlEl.querySelector(".accordion-button");
      const collapse = document.getElementById(`collapse-${lvl}`);

      if (headerBtn) {
        if (locked) {
          headerBtn.disabled = true;
          headerBtn.classList.add("collapsed");
        } else {
          headerBtn.disabled = false;
          headerBtn.setAttribute("data-bs-toggle", "collapse");
          headerBtn.setAttribute("data-bs-target", `#collapse-${lvl}`);
        }
      }

      if (collapse && locked) {
        collapse.classList.remove("show");
      }

      updateStatusBadge(lvlEl, lvl, achieved, unlockedMax, locked);
    }

    // 3) badges superiores
    const achievedEl = document.getElementById("achieved-badge");
    const currentEl = document.getElementById("current-badge");
    if (achievedEl) achievedEl.textContent = achieved;
    if (currentEl) currentEl.textContent = unlockedMax;
  }

  // eventos
  document.querySelectorAll("input.js-rating").forEach(inp => {
    inp.addEventListener("change", recompute);
  });

  // init
  recompute();
</script>
{% endblock %}
