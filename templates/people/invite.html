{% extends "base.html" %}
{% block title %}Invitar usuarios · TalentMap{% endblock %}

{% block content %}
<div class="container">
  <div class="hero-card d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2 p-4">
    <div>
      <h3 class="mb-0">Invitar usuarios</h3>
      <div class="text-muted small">Gestiona invitaciones e importa colaboradores de forma segura desde Excel.</div>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <a class="btn btn-outline-success" href="{% url 'download_sample_excel' %}">Descargar plantilla Excel</a>
      <a class="btn btn-outline-secondary" href="{% url 'home' %}">Volver</a>
    </div>
  </div>

  <!-- Importar Excel -->
  <div class="card p-4 shadow-sm border-0 mb-4 rounded-4">
    <h5 class="mb-2">Importar desde Excel</h5>
    <p class="text-muted small mb-3">Sube un archivo con columnas: nombre, apellido, email, departamento, rol y manager_email. El email es obligatorio.</p>
    <form method="post" action="{% url 'import_users_excel' %}" enctype="multipart/form-data" class="d-flex gap-2 align-items-end flex-wrap">
      {% csrf_token %}
      <div class="flex-grow-1">
        <input type="file" name="excel_file" accept=".xlsx,.xls" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary">Importar</button>
    </form>
  </div>

  <div class="row g-3">
    <!-- NUEVA INVITACIÓN -->
    <div class="col-lg-5">
      <div class="card p-4 shadow-sm border-0 rounded-4 h-100">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h5 class="mb-1">Nueva invitación</h5>
            <div class="text-muted small">Se enviará un correo con un enlace de registro.</div>
          </div>
          <span class="badge text-bg-light border">HR</span>
        </div>

        <form method="post" id="invite-form">
          {% csrf_token %}

          <div class="row g-2 mb-3">
            <div class="col">
              <label class="form-label" for="id_first_name">Nombre</label>
              {{ form.first_name }}
            </div>
            <div class="col">
              <label class="form-label" for="id_last_name">Apellido</label>
              {{ form.last_name }}
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label" for="id_email">Correo electrónico</label>
            {{ form.email }}
            {% if form.email.errors %}
              <div class="text-danger small mt-1">{{ form.email.errors }}</div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label" for="id_department">Departamento</label>
            {{ form.department }}
          </div>

          <div class="mb-3">
            <label class="form-label" for="id_role">Rol</label>
            {{ form.role }}
          </div>

          <div class="mb-3">
            <label class="form-label" for="id_manager">Superior / Jefe (opcional)</label>
            {{ form.manager }}
            <div class="text-muted small mt-1">Si lo asignas, podrá evaluar al usuario al registrarse.</div>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              Enviar invitación
            </button>
            {% if request.GET.department %}
              <a class="btn btn-outline-secondary" href="{% url 'invite_user' %}">Limpiar filtro</a>
            {% endif %}
          </div>
        </form>
      </div>
    </div>

    <!-- PENDIENTES -->
    <div class="col-lg-7">
      <div class="card p-4 shadow-sm border-0 rounded-4 h-100">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h5 class="mb-1">Invitaciones pendientes</h5>
            <div class="text-muted small">
              Reenvía si el usuario no lo recibió o cancela si ya no procede.
            </div>
          </div>

          {% if pending_invites %}
            <span class="badge text-bg-secondary">{{ pending_invites|length }} pendientes</span>
          {% endif %}
        </div>

        {% if pending_invites %}
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Email</th>
                  <th>Departamento</th>
                  <th>Rol</th>
                  <th class="text-nowrap">Enviada</th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for inv in pending_invites %}
                  <tr>
                    <td class="fw-semibold">{{ inv.email }}</td>
                    <td class="text-muted">{{ inv.department.name }}</td>
                    <td class="text-muted">{{ inv.role.name }}</td>
                    <td class="text-muted text-nowrap">{{ inv.created_at|date:"d/m/Y" }}</td>

                    <td class="text-end">
                      <div class="d-inline-flex gap-2 align-items-center">
                        <!-- Copiar enlace (opcional, útil) -->
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-secondary"
                          data-copy="{{ SITE_URL }}/accounts/register/?token={{ inv.token }}"
                          title="Copiar enlace"
                        >
                          Copiar link
                        </button>

                        <!-- Reenviar -->
                        <form method="post" action="{% url 'resend_invite' inv.token %}" class="m-0">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-sm btn-outline-primary">
                            Reenviar
                          </button>
                        </form>

                        <!-- Cancelar (con confirm) -->
                        <form method="post" action="{% url 'cancel_invite' inv.token %}" class="m-0"
                              onsubmit="return confirm('¿Cancelar la invitación para {{ inv.email }}?');">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-sm btn-outline-danger">
                            Cancelar
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted mb-0">No hay invitaciones pendientes.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .hero-card {
    background: linear-gradient(135deg, #f8fbff 0%, #eef4ff 100%);
    border: 1px solid #e1e8f5;
    border-radius: 1rem;
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  // Actualiza roles por AJAX al cambiar departamento (sin perder datos del formulario)
  const deptSelect = document.getElementById('id_department');
  const roleSelect = document.getElementById('id_role');
  function loadRolesForDept() {
    if (!deptSelect || !roleSelect) return;
    const deptId = deptSelect.value;
    const prevRole = roleSelect.getAttribute('data-selected') || roleSelect.value;
    roleSelect.innerHTML = '<option value="">Selecciona rol</option>';
    if (deptId) {
      roleSelect.innerHTML = '<option value="">Cargando roles...</option>';
      fetch('{% url "api_roles_by_department" 999999 %}'.replace('999999', deptId), {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
        .then(r => {
          if (!r.ok) throw new Error('status_' + r.status);
          return r.json();
        })
        .then(data => {
          roleSelect.innerHTML = '<option value="">Selecciona rol</option>';
          data.roles.forEach(function(r) {
            const opt = document.createElement('option');
            opt.value = r.id;
            opt.textContent = r.name;
            roleSelect.appendChild(opt);
          });
          if (!data.roles.length) {
            roleSelect.innerHTML = '<option value="">No hay roles en este departamento</option>';
            return;
          }
          if (prevRole) {
            roleSelect.value = prevRole;
          }
        })
        .catch(function() {
          roleSelect.innerHTML = '<option value="">Error al cargar roles</option>';
        });
    } else {
      roleSelect.innerHTML = '<option value="">Selecciona departamento primero</option>';
    }
  }
  if (deptSelect && roleSelect) {
    roleSelect.setAttribute('data-selected', roleSelect.value);
    deptSelect.addEventListener('change', loadRolesForDept);
    if (deptSelect.value) loadRolesForDept();
  }

  // Copy link UX (sin dependencias)
  document.querySelectorAll('[data-copy]').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const text = btn.getAttribute('data-copy');
      try {
        await navigator.clipboard.writeText(text);
        const old = btn.innerText;
        btn.innerText = 'Copiado ✅';
        setTimeout(() => btn.innerText = old, 1200);
      } catch (e) {
        // fallback
        window.prompt("Copia este enlace:", text);
      }
    });
  });
</script>
{% endblock %}
